# MOM系统架构图

## 一、整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
│  Web前端 / 移动端 / 第三方系统集成                               │
└────────────────────────┬────────────────────────────────────────┘
                         │ HTTP/REST API
┌────────────────────────▼────────────────────────────────────────┐
│                    Ncp.Mom.Web (表现层)                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  FastEndpoints (API端点)                                 │   │
│  │  - ProductionPlanEndpoints                               │   │
│  │  - WorkOrderEndpoints                                    │   │
│  │  - QualityInspectionEndpoints                            │   │
│  │  - EquipmentEndpoints                                    │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Commands (命令)                                         │   │
│  │  - CreateProductionPlanCommand                           │   │
│  │  - CreateWorkOrderCommand                                │   │
│  │  - ReportWorkOrderProgressCommand                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Queries (查询)                                          │   │
│  │  - GetProductionPlanQuery                                │   │
│  │  - GetWorkOrderQuery                                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  DomainEventHandlers (领域事件处理器)                    │   │
│  │  - WorkOrderCreatedDomainEventHandler                    │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  IntegrationEventHandlers (集成事件处理器)                │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│              Ncp.Mom.Infrastructure (基础设施层)                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  ApplicationDbContext (EF Core)                         │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Repositories (仓储实现)                                 │   │
│  │  - ProductionPlanRepository                              │   │
│  │  - WorkOrderRepository                                   │   │
│  │  - QualityInspectionRepository                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  EntityConfigurations (实体配置)                        │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                  Ncp.Mom.Domain (领域层)                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  AggregatesModel (聚合根)                                │   │
│  │  - ProductionPlan                                         │   │
│  │  - WorkOrder                                              │   │
│  │  - Routing                                                │   │
│  │  - QualityInspection                                      │   │
│  │  - Equipment                                              │   │
│  │  - Bom                                                    │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  DomainEvents (领域事件)                                 │   │
│  │  - ProductionPlanCreatedDomainEvent                       │   │
│  │  - WorkOrderCreatedDomainEvent                           │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 二、核心业务流程

### 2.1 生产计划到工单流程

```
┌──────────────┐
│ 创建生产计划  │
└──────┬───────┘
       │
       ▼
┌─────────────────────────┐
│ ProductionPlanCreated   │
│ DomainEvent             │
└──────┬──────────────────┘
       │
       ▼
┌──────────────┐
│ 审批生产计划  │
└──────┬───────┘
       │
       ▼
┌─────────────────────────┐
│ ProductionPlanApproved  │
│ DomainEvent             │
└──────┬──────────────────┘
       │
       ▼
┌──────────────┐
│ 启动生产计划  │
└──────┬───────┘
       │
       ▼
┌─────────────────────────┐
│ ProductionPlanStarted   │
│ DomainEvent             │
└──────┬──────────────────┘
       │
       │ 领域事件处理器
       ▼
┌──────────────┐
│ 创建工单      │
└──────┬───────┘
       │
       ▼
┌─────────────────────────┐
│ WorkOrderCreated        │
│ DomainEvent             │
└──────┬──────────────────┘
       │
       │ 领域事件处理器
       ▼
┌──────────────┐
│ 创建质检单    │
└──────────────┘
```

### 2.2 工单执行流程

```
┌──────────────┐
│ 启动工单      │
└──────┬───────┘
       │
       ▼
┌──────────────┐      ┌──────────────┐
│ 分配设备      │◄─────│ 设备管理      │
└──────┬───────┘      └──────────────┘
       │
       ▼
┌──────────────┐
│ 工单报工      │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 质量检验      │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 工单完成      │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 释放设备      │
└──────────────┘
```

## 三、聚合关系图

```
ProductionPlan (生产计划)
    │
    │ 1:N
    ▼
WorkOrder (工单)
    │
    ├──► Routing (工艺路线)
    │        │
    │        └──► RoutingOperation (工序)
    │
    ├──► QualityInspection (质检单)
    │
    └──► Equipment (设备)

Product (产品)
    │
    ├──► Bom (物料清单)
    │        │
    │        └──► BomItem (BOM项)
    │
    └──► Routing (工艺路线)
```

## 四、事件流图

```
领域事件 (Domain Events)
    │
    ├──► 领域事件处理器 (DomainEventHandlers)
    │        │
    │        └──► 同一事务内处理
    │
    └──► 集成事件转换器 (IntegrationEventConverters)
            │
            ▼
集成事件 (Integration Events)
    │
    └──► CAP消息总线 (RabbitMQ/Kafka)
            │
            └──► 集成事件处理器 (IntegrationEventHandlers)
                    │
                    └──► 跨服务通信
```

## 五、数据流图

```
API请求
    │
    ▼
Endpoint (FastEndpoints)
    │
    ▼
Command/Query (MediatR)
    │
    ├──► Command ──► CommandHandler ──► Repository ──► Aggregate ──► DomainEvent
    │                                                                      │
    │                                                                      ▼
    │                                                              DomainEventHandler
    │
    └──► Query ──► QueryHandler ──► DbContext ──► DTO ──► Response
```

## 六、技术栈架构

```
┌─────────────────────────────────────────┐
│  ASP.NET Core + .NET 9                  │
├─────────────────────────────────────────┤
│  FastEndpoints (API路由)                │
│  MediatR (CQRS)                         │
│  FluentValidation (验证)                │
├─────────────────────────────────────────┤
│  Entity Framework Core (ORM)            │
│  MySQL/PostgreSQL/SQL Server            │
├─────────────────────────────────────────┤
│  CAP (分布式事务/事件总线)               │
│  RabbitMQ/Kafka                         │
├─────────────────────────────────────────┤
│  Redis (缓存/分布式锁)                  │
│  Hangfire (任务调度)                     │
├─────────────────────────────────────────┤
│  Prometheus (监控)                      │
│  Serilog (日志)                         │
└─────────────────────────────────────────┘
```

